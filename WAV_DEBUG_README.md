# WAV Debug File Creation

This document explains how to enable and use the WAV debug file creation functionality for debugging audio flow issues in the Unmute system.

## Overview

The WAV debug functionality creates WAV files at different stages of the audio processing pipeline to help debug audio flow issues. Files are created at these key stages:

### Backend Stages
1. **tts_audio_queue** - Audio data when queued in OrpheusTextToSpeech audio_queue
2. **tts_yielded** - Audio data when yielded from OrpheusTextToSpeech iterator
3. **output_queue** - Audio data when put into conversation output_queue
4. **websocket_emit** - Audio data just before being sent to WebSocket
5. **orpheus_modal_complete** - Complete audio generated by Orpheus TTS Modal service (streaming)
6. **orpheus_modal_nonstream** - Complete audio generated by Orpheus TTS Modal service (non-streaming)

### Frontend Stages
1. **audio-processor-received** - Audio frames received by audio-output-processor
2. **audio-processor-output** - Audio data output by audio-output-processor

## Backend Configuration

### Environment Variables

Set these environment variables to enable backend WAV debug file creation:

```bash
export DEBUG_WAV_ENABLED=true
export DEBUG_WAV_DIR=/tmp/unmute_audio_debug
export USE_MODAL_VOLUME=false  # Set to "true" for Modal deployment
```

- `DEBUG_WAV_ENABLED`: Set to "true" to enable WAV file creation (default: "true")
- `DEBUG_WAV_DIR`: Directory where WAV files will be saved (default: "/tmp/unmute_audio_debug")
- `USE_MODAL_VOLUME`: Set to "true" to use Modal volumes for storage (default: "false")

### Modal Deployment Configuration

When running on Modal, the system automatically uses Modal volumes for WAV file storage:

- Volume name: `debug-audio-volume`
- Mount point: `/debug-audio`
- Files are automatically committed to the volume after writing

### File Naming Convention

Backend WAV files are named with the pattern:
```
{conversation_id}_{stage}_{timestamp}.wav
```

Examples:
- `orpheus_modal_tts_audio_queue_20231201_143052_123.wav`
- `12345678_output_queue_20231201_143052_456.wav`

**Orpheus Modal WAV files** use a different pattern:
```
orpheus_modal_{type}_{timestamp}.wav
```

Examples:
- `orpheus_modal_complete_20231201_143052_123.wav` (streaming generation)
- `orpheus_modal_nonstream_20231201_143052_456.wav` (non-streaming generation)

## Frontend Configuration

### Configuration

Frontend WAV debug is currently enabled by default in the code. The system automatically downloads WAV files when audio is processed.

To disable frontend debug, modify the `DEBUG_WAV_ENABLED` constant in `audio-output-processor.js`:

```javascript
const DEBUG_WAV_ENABLED = false;  // Set to false to disable
```

### File Download

Frontend WAV files are automatically downloaded to your browser's default download directory when created. The audio worklet sends WAV data to the main thread where Blob creation and file downloads are handled.

Frontend files are named with the pattern:
```
audio-processor-{stage}-{timestamp}.wav
```

Examples:
- `audio-processor-received-2023-12-01T14-30-52-123Z.wav`
- `audio-processor-output-2023-12-01T14-30-52-456Z.wav`

## Usage Examples

### Full Debug Setup

#### Local Development

1. **Backend**: Set environment variables and restart the backend service
   ```bash
   export DEBUG_WAV_ENABLED=true
   export DEBUG_WAV_DIR=/tmp/unmute_audio_debug
   export USE_MODAL_VOLUME=false
   # Restart your backend service
   ```

2. **Frontend**: Open the application (frontend debug is enabled by default)
   ```
   http://localhost:3000/
   ```

3. **Generate Audio**: Start a conversation and speak to trigger TTS audio generation

4. **Check Files**: 
   - Backend files: Check `/tmp/unmute_audio_debug/` directory
   - Frontend files: Check your browser's download directory

#### Modal Deployment

1. **Deploy**: The Modal services are automatically configured with WAV debug enabled

2. **Frontend**: Open the application (frontend debug is enabled by default)
   ```
   https://your-modal-app.modal.run/
   ```

3. **Generate Audio**: Start a conversation and speak to trigger TTS audio generation

4. **Download Files**: Use Modal CLI to download debug files from the volume
   ```bash
   # List files in the debug volume
   modal volume ls debug-audio-volume
   
   # Download specific files
   modal volume get debug-audio-volume conversation_id_stage_timestamp.wav ./local-file.wav
   
   # Download all files to a local directory
   mkdir -p ./debug-wav-files
   modal volume get debug-audio-volume . ./debug-wav-files/
   ```

### Debugging Audio Issues

When debugging audio issues, compare the WAV files from different stages:

1. **Check TTS Generation**: Look at `tts_audio_queue` and `tts_yielded` files to verify TTS is generating audio correctly
2. **Check Backend Flow**: Compare `output_queue` and `websocket_emit` files to ensure audio flows correctly through the backend
3. **Check Frontend Reception**: Look at `audio-processor-received` files to verify audio reaches the frontend
4. **Check Frontend Output**: Look at `audio-processor-output` files to verify audio is processed correctly for playback

### Performance Considerations

- WAV file creation adds I/O overhead, so only enable for debugging
- Frontend files are downloaded automatically, which may clutter your downloads folder
- Backend files accumulate in the debug directory and should be cleaned up periodically

### Troubleshooting

**No backend WAV files created:**
- Check that `DEBUG_WAV_ENABLED=true` is set
- Verify the debug directory exists and is writable
- Check backend logs for WAV debug messages

**No frontend WAV files downloaded:**
- Ensure `debug_wav=true` is in the URL
- Check browser console for WAV debug messages
- Verify browser allows automatic downloads

**Empty or corrupted WAV files:**
- Check that audio data is not empty at that stage
- Verify sample rate matches expected values (typically 24000 Hz)
- Look for error messages in logs

## File Format

All WAV files are created with these specifications:
- Format: PCM (uncompressed)
- Channels: 1 (mono)
- Sample Rate: Matches the audio data (typically 24000 Hz for TTS, 48000 Hz for frontend)
- Bit Depth: 16-bit signed integer
- Byte Order: Little-endian

## Cleanup

Remember to disable debug mode and clean up files when finished:

```bash
# Disable backend debug
unset DEBUG_WAV_ENABLED
unset DEBUG_WAV_DIR

# Clean up backend files
rm -rf /tmp/unmute_audio_debug/

# Clean up frontend files from downloads folder manually
```
